#!/usr/bin/env bash

# ASDF required script: install
# Phase: Version Installation (Task 4.6)
# Responsibility: Move downloaded bash_unit artifact into final install path.
# Further logic for directory creation, file move, permissions, validation in Tasks 4.7 - 4.10.

set -euo pipefail

# Exit codes:
# 0 success
# 1 general error
# 2 (reserved for network, not used here)
# 3 invalid input

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# shellcheck source=../lib/utils.sh
if [ -f "$ROOT_DIR/lib/utils.sh" ]; then
  . "$ROOT_DIR/lib/utils.sh"
fi

INSTALL_DIR="${ASDF_INSTALL_PATH:-}"
if [ -z "$INSTALL_DIR" ]; then
  log_error "ASDF_INSTALL_PATH is not set"
  exit 3
fi

TARGET_BIN_DIR="$INSTALL_DIR/bin"

if ! mkdir -p "$TARGET_BIN_DIR"; then
  log_error "Failed to create install directory: $TARGET_BIN_DIR"
  exit 1
fi

DOWNLOAD_DIR="${ASDF_DOWNLOAD_PATH:-}"
if [ -z "$DOWNLOAD_DIR" ]; then
  log_error "ASDF_DOWNLOAD_PATH is not set"
  exit 3
fi

SOURCE_FILE="$DOWNLOAD_DIR/bash_unit"
TARGET_FILE="$TARGET_BIN_DIR/bash_unit"

if [ ! -f "$SOURCE_FILE" ]; then
  log_error "Source file missing: $SOURCE_FILE"
  exit 1
fi

if ! cp "$SOURCE_FILE" "$TARGET_FILE"; then
  log_error "Failed to copy $SOURCE_FILE to $TARGET_FILE"
  exit 1
fi

if ! chmod 755 "$TARGET_FILE"; then
  log_error "Failed to set executable permissions on $TARGET_FILE"
  exit 1
fi

if [ ! -f "$TARGET_FILE" ]; then
  log_error "Installed file missing: $TARGET_FILE"
  exit 1
fi

if [ ! -x "$TARGET_FILE" ]; then
  log_error "Installed file is not executable: $TARGET_FILE"
  exit 1
fi

echo ""  # final placeholder; successful installation